name: Android CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up mise
        uses: jdx/mise-action@v2
        with:
          install: true
          cache: true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build APKs and Run Tests (Parallel)
        run: ./gradlew assembleRelease assembleDebug testDebugUnitTest --no-daemon --parallel --build-cache

      # Upload artifacts for both PR review and release job
      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apks-${{ github.sha }}
          path: |
            app/build/outputs/apk/release/app-release-unsigned.apk
            app/build/outputs/apk/debug/app-debug.apk
          retention-days: 1

  # Create nightly release on push to main
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download APK Artifacts
        uses: actions/download-artifact@v4
        with:
          name: apks-${{ github.sha }}
          path: apks

      - name: List downloaded artifacts
        run: find apks -type f -name "*.apk"

      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # Delete previous nightly release to save storage
      - name: Delete previous nightly release
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: nightly
          github_token: ${{ secrets.GITHUB_TOKEN }}
          delete_release: true
        continue-on-error: true

      - name: Create nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "Nightly Build (${{ steps.date.outputs.date }})"
          body: |
            ## üåô Nightly Build

            **Commit:** ${{ github.sha }}
            **Date:** ${{ steps.date.outputs.date }}
            **Short SHA:** ${{ steps.sha.outputs.short }}

            ### Downloads
            | Variant | Description |
            |---------|-------------|
            | `app-release-unsigned.apk` | Optimized release build (~2.5 MB) |
            | `app-debug.apk` | Debug build with LeakCanary (~16 MB) |

            ### Installation
            1. Download the APK for your use case
            2. Enable "Install from unknown sources" on your device
            3. Install the APK

            ‚ö†Ô∏è **Note:** These are unsigned development builds for testing purposes.

            ---
            _This release is automatically replaced on each commit to main._
          files: |
            apks/release/app-release-unsigned.apk
            apks/debug/app-debug.apk
          prerelease: true
          make_latest: false

      # Cleanup artifact to save storage (optional, artifacts auto-expire)
      - name: Delete Artifact
        uses: geekyeggo/delete-artifact@v5
        with:
          name: apks-${{ github.sha }}

